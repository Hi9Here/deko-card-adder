<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../card-info-link-input/card-info-link-input.html">
<link rel="import" href="../paper-button-group/paper-button-group.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../content-card/content-card.html">
<link rel="import" href="../link-display/link-display.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../input-image/input-image.html">
<link rel="import" href="../deko-cards/deko-cards.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-styles/color.html">
<dom-module id="deko-card-editor">
  <template>
    <style>
      #cardInputs {
        margin: 15px
      }
      .templateButtons {
        text-align: center;
        margin-top: 40px;
      }
      paper-button-group {
        margin: 15px;
      }
      paper-fab {
        position: fixed;
        right: 25px;
        bottom: 30px;          
      }
    </style>
    <template is="dom-if" if="[[!noAdd]]">
      <paper-fab icon="add" on-tap="add"></paper-fab>
    </template>
    <paper-dialog id="dialog" modal>
      <paper-dialog-scrollable>
        <template is="dom-if" if="[[pickType]]">
          <template is="dom-repeat" items="[[objectToArray(theTemplates)]]">
            <deko-card card="[[item]]" icon="[[item.icon]]" on-open="addThis"></deko-card>
          </template>
        </template>
        <template is="dom-if" if="[[!pickType]]">
          <div id="cardInputs" inner-h-t-m-l="[[inputFrom]]"></div>
        </template>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button on-tap="delete" style="color:#333">Delete</paper-button>
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="save" raised style="background:#ff4081;color:#fff">Save</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is: 'deko-card-editor',
      properties: {
        card:{
          type: Object,
          notify: true,
        },
        inputFrom:{
          computed: ("getThis(usedTemplate.input)"),
        },
        updateValues: {
          computed: ("getUpdateValues(card.*)")
        },
        usedTemplate: {
          computed: "getUsedTemplate(theTemplates, card, useTemplates, useTemplate)"
        },
        noAdd:{
          type:Boolean,
          value:false,
        },
        pickType:{
          type:Boolean,
          value:false,
        },
        useTemplates: {
          type: Object,
          value: ""
        },
        useTemplate: {
          value: "link-display"
        },
        theTemplates: {
          value:{
            "link-display": {
              title: "link",
              input: "<card-info-link-input label=\"link\"></card-info-link-input>", 
              icon: "bookmark",
              locked: "true",
              cardType: "link-display",
            },
            "content-card": {
              title: "content",
              input: "<paper-input label=\"title\"></paper-input><paper-input label=\"desc\"></paper-input><image-input label=\"image\"></image-input>", 
              icon: "chrome-reader-mode",
              cardType: "content-card",
              locked: "true",
            },
          }
        },
        theTemplate: {
          computed: "setTemplate(useTemplate, usedTemplate, theTemplates, useTemplates)"
        }
      },
      getThis: function(inputForm) {
        this.async(this.getUpdateValues, 100) // let it load
        return inputForm
      },
      addThis: function(e,d) {
        console.log(e,d)
        if (d) {
          this.useTemplate = d
          this.pickType = false
        }
      },
      getInputFrom: function(form) {
        this.async(this.getUpdateValues, 100) // let it load
        return form
      },
      getUsedTemplate: function(theTemplates, card, useTemplates, useTemplate) {
        if (!useTemplates) {
          return theTemplates[useTemplate]
        } else {
          if (typeof useTemplates === "string") {
            useTemplates = JSON.parse(useTemplates)
          }
          return this.objectToArray(useTemplates)[0]["__key"]
        }
        // rem \/
        return this.objectToArray(theTemplates).reduce(function(previousValue, currentValue){
          if (currentValue.output == card.output) {
            return currentValue["$key"]
          } else {
            return previousValue
          }
        }, "")
      },
      setTemplate: function(useTemplate, usedTemplate, theTemplates, useTemplates) {
        if (!this.card){
          this.card = {}
        }
        if (useTemplates) {
          if (typeof useTemplates === "string") {
            useTemplates = JSON.parse(useTemplates)
          }
          this.card.cardType = useTemplates[useTemplate].cardType
          return this.card.input = useTemplates[useTemplate].input
        } else if (useTemplate) {
          this.card.cardType = theTemplates[useTemplate].cardType
          return this.card.input = theTemplates[useTemplate].input
        } else if (this.card.input) {
          return this.card.input
        }
      },
      getUpdateValues: function(card) {
        if (card) {
          this.async(this.getUpdateValues, 100) // let it load
        } else {
          if (!this.card) {
            this.card = {}
          }
          var inputForm = this.$$("#cardInputs")
          var items = inputForm.querySelectorAll("[label]")
          for (var i=0, max=items.length; i < max; i++) {
            if (this.card.hasOwnProperty(items[i].label)) {
              items[i].value = this.card[items[i].label]
            }
          }
          return "Done"
        }
      },
      save: function() {
        if (!this.card){
          this.card = {}
        }
        if (this.card.cardIcon) {
          delete(this.card.cardIcon)
        }
        var inputForm = this.$$("#cardInputs")
        var items = inputForm.querySelectorAll("[label]")
        for (var i=0, max=items.length; i < max; i++) {
          if (items[i].value) {
            this.card[items[i].label] = items[i].value
          }
        }
        this.close('save')
      },
      delete: function() {
        this.close('delete')
      },
      close: function(detail) {
        var inputForm = this.$$("#cardInputs")
        var items = inputForm.querySelectorAll("[label]")
        for (var i=0, max=items.length; i < max; i++) {
          this.card[items[i].label] = items[i].value
        }
        if (this.__editedCardElement) {
          this.__editedCardElement.style.opacity = 1
          this.__editedCardElement = null
        }
        this.fire('close', detail, { bubbles: false })
        this.$.dialog.close()
      },
      add: function() {
        this.open()
      },
      open: function(card) {
        if (card) {
          if (this.theTemplates[card.cardType]) {
            this.theTemplates = card.cardType
          } else {
            this.pickType = true
          }
          this.card = card
        } else {
          
          this.pickType = true
        }
        this.async(this.getUpdateValues, 100)
        this.$.dialog.open()
      },
      objectToArray: function(data) { //rewrite as .map
        var output = []
        if (data) {
          var keys = Object.keys(data)
          for (var i = 0; i < keys.length; i++) {
            if (typeof data[keys[i]] === 'object') {
              data[keys[i]]["__key"] = keys[i]
              output.push(data[keys[i]])
            }
          }
        }
        return output
      }
    })
  </script>
</dom-module>
