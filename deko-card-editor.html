<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../card-info-link-input/card-info-link-input.html">
<link rel="import" href="../paper-button-group/paper-button-group.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../input-image/input-image.html">
<link rel="import" href="../paper-styles/color.html">
<dom-module id="deko-card-editor">
  <template>
    <style>
      #cardInputs {
        margin: 15px
      }
      .templateButtons {
        text-align: center;
        margin-top: 40px;
      }
      paper-button-group {
        margin: 15px
      }
    </style>
    <paper-dialog id="dialog" modal>
      <paper-dialog-scrollable>
        <paper-button-group selected="{{useTemplate}}">
          <template is="dom-repeat" items="{{objectToArray(theTemplates)}}">
            <paper-button name="{{item.$key}}" raised><iron-icon icon="{{item.icon}}"></iron-icon></paper-button>
          </template>
        </paper-button-group>
        <div id="cardInputs" inner-h-t-m-l="[[inputFrom]]"></div>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button on-tap="delete" style="color: #333;">Delete</paper-button>
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="save"  raised style="background: #ff4081; color: #fff;">Save</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is: 'deko-card-editor',
      properties: {
        card: {
          type: Object,
          notify: true,
          value: {}
        },
        inputFrom:{
          computed: ("getInputFrom(theTemplate)")
        },
        updateValues: {
          computed: ("getUpdateValues(card.*)")
        },
        usedTemplate: {
          computed: "getUsedTemplate(theTemplates, card)"
        },
        useTemplate: {
          value:"link"
        },
        theTemplates: {
          value:{
            link: {
              input: "<paper-input label=\"link\"><\/paper-input>\r\n<input-image label=\"image\" width=\"100\" max-height=\"100\" ><\/input-image><paper-input label=\"title\"><\/paper-input><paper-input label=\"desc\"><\/paper-input>", 
              icon: "bookmark",
            },
            event: {
              input: "<paper-input label=\"Event\" char-counter maxlength=\"100\"><\/paper-input>\r\n<paper-input label=\"Url\" char-counter maxlength=\"100\"><\/paper-input>",
              icon: "event",
            },
            shopping: {
              outputType: "shopping-card",
              input: "<paper-input label=\"Link\"><\/paper-input>\r\n<input-image label=\"ImageUrl\" width=\"250\" max-height=\"100\" ><\/input-image><paper-input label=\"Title\"><\/paper-input><paper-input label=\"Subtitle\"><\/paper-input>\r\n<paper-input label=\"Cost\" type=\"number\" ><div perfix>\u00A3<\/div><\/paper-input>\r\n<paper-input label=\"Company\"><\/paper-input>",
              icon: "shopping-cart",
            },
            booking: {
              output: "<paper-toolbar><span class=\"title\" title><\/span><img style=\"border-radius:45px\" src=\"{{userPic}}\" title=\"{{userName}}\" \/><\/paper-toolbar><a title=\"{{Title}}\" href=\"{{Url}}\">{{Title}}<\/a>",
              input: "<paper-input label=\"Hotel\" char-counter maxlength=\"100\"><\/paper-input>\r\n<paper-input label=\"Url\" char-counter maxlength=\"100\"><\/paper-input>",
              icon: "assignment",
            },
          }
        },
        theTemplate: {
          computed: "setTemplate(useTemplate, usedTemplate, theTemplates, card)"
        }
      },
      getInputFrom: function(form) {
        this.async(this.getUpdateValues, 100) // let it load
        return form
      },
      getUsedTemplate: function(theTemplates, card) {
         return this.objectToArray(theTemplates).reduce(function(previousValue, currentValue){
           if (currentValue.output == card.output) {
             return currentValue["$key"]
           } else {
             return previousValue
           }
         }, "")
      },
      setTemplate: function(useTemplate, usedTemplate, theTemplates, card) {
        if (useTemplate) {
          this.card.output = theTemplates[useTemplate].output
          return this.card.input = theTemplates[useTemplate].input
        } else if (card.output) {
          if (usedTemplate) {
            this.useTemplate = usedTemplate
          }
          return this.card.input
        }
      },
      getUpdateValues: function(card) {
        if (card) {
          this.async(this.getUpdateValues, 100) // let it load
        } else {
          var inputForm = this.$$("#cardInputs")
          var items = inputForm.querySelectorAll("[label]")
          for (var i=0, max=items.length; i < max; i++) {
            items[i].value = this.card[items[i].label]
          }
          return "Done"
        }
      },
      save: function() {
        var inputForm = this.$$("#cardInputs")
        var items = inputForm.querySelectorAll("[label]")
        for (var i=0, max=items.length; i < max; i++) {
          this.card[items[i].label] = items[i].value
        }
        this.close('save')
      },
      delete: function() {
        this.close('delete')
      },
      close: function(detail) {
        var inputForm = this.$$("#cardInputs")
        var items = inputForm.querySelectorAll("[label]")
        for (var i=0, max=items.length; i < max; i++) {
          this.card[items[i].label] = items[i].value
        }
        if (this.__editedCardElement) {
          this.__editedCardElement.style.opacity = 1
          this.__editedCardElement = null
        }
        this.fire('close', detail, { bubbles: false })
        this.$.dialog.close()
      },
      open: function(card) {
        if (card) {
          this.card = card
        }
        if (this.card.cardIcon) {
          this.card.image = this.card.cardIcon + ""
          delete(this.card.cardIcon)
        }
        this.$.dialog.open()
      },
      objectToArray: function(data) { //rewrite as .map
        var output = []
        if (data) {
          var keys = Object.keys(data)
          for (var i = 0; i < keys.length; i++) {
            if (typeof data[keys[i]] === 'object') {
              data[keys[i]]["$key"] = keys[i]
              output.push(data[keys[i]])
            }
          }
        }
        return output
      }
    })
  </script>
</dom-module>
